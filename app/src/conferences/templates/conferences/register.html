{% extends "base.html" %}
{% load i18n %}
{% load materializecss %}

{% block content %}
<div class="container">
    <h3>
        {% if object %}
        {% trans "Update preferences" %}
        {% else %}
        {% trans "Register" %}
        {% endif %}
    </h3>
    <div class="row">
        <div class="col s12 m8">
            <blockquote style="border-left-color: #3333cc">
                <i>{% trans "Prices (per night)" %}:</i><br />
                {% trans "Accommodation" %}: <strong>{{ zosia.price_accommodation }} PLN</strong><br />
                {% trans "Accommodation + breakfast" %}: <strong>{{ zosia.price_accommodation_breakfast }} PLN</strong><br />
                {% trans "Accommodation + dinner" %}: <strong>{{ zosia.price_accommodation_dinner }} PLN</strong><br />
                {% trans "Accommodation + both meals" %}: <strong>{{ zosia.price_whole_day }} PLN</strong><br />
            </blockquote>
            <blockquote style="border-left-color: #9900ff">
                <i>{% trans "Total cost (updated automatically)" %}:</i><br />
                <strong><span id="total-price">{% if object %}{{object.price}}{% else %}0{% endif %}</span> PLN</strong>
            </blockquote>
        </div>
    </div>
    <form method="post">
        {% csrf_token %}
        {% include '_form.html' %}
    </form>
</div>
{% endblock content %}

{% block custom_scripts %}
<script type="text/javascript">
  $(document).ready(function() {
    $('select').formSelect();
    $('textarea').addClass("materialize-textarea");

    {% if payed %}
    const payed = true;
    {% else %}
    const payed = false;
    {% endif %}

    const dependencies = {
        {% for accommodation, meals in field_dependencies.items %}
        "#id_{{ accommodation }}" : [ {% for m in meals %} "#id_{{ m }}", {% endfor %} ],
        {% endfor %}
    }

    const onChange = changedIds => {
      changedIds.forEach(accomm => {
        const isParentChecked = $(accomm).is(':checked')
        dependencies[accomm].forEach(child => {
          $(child).attr('disabled', payed || !isParentChecked);
          if (!isParentChecked) {
            $(child).prop('checked', false);
          }
        })
      })
    }

    for (accomm in dependencies) {
      $(accomm).change(event => {
        onChange(["#" + event.currentTarget.id])
      })
    }

    onChange(Object.keys(dependencies));
  });
</script>
{% endblock custom_scripts %}
