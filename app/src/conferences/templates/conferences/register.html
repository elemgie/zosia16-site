{% extends "base.html" %}
{% load i18n %}
{% load materializecss %}

{% block content %}
<!-- Modal Structure -->
<div id="add_org" class="modal">
  <div class="modal-content">
    <h4>Add organization</h4>
    <div class="row">
      <div class="input-field col s12">
        <textarea id="org_name" class="materialize-textarea" name="contact" cols="40" rows="10"></textarea>
        <label class="" for="org_name">
          Organization name
        </label>
      </div>
    </div>
  </div>
  <div class="modal-footer">
    <a id="add_org_accept" href="#!" class="modal-close waves-effect waves-green btn-flat">Add</a>
  </div>
</div>
<div class="container">
    <h3>
        {% if object %}
        {% trans "Update preferences" %}
        {% else %}
        {% trans "Register" %}
        {% endif %}
    </h3>
    <div class="row">
        <div class="col s12 m8">
            <div class="card">
                <div class="card-content">
                    <span class="card-title">{% trans "Cost" %}</span>
                    <blockquote style="border-left-color: #3333cc">
                        <i>{% trans "Prices (per night)" %}:</i><br />
                        {% trans "Accommodation" %}: <strong>{{ zosia.price_accommodation }} PLN</strong><br />
                        {% trans "Accommodation + breakfast" %}: <strong>{{ zosia.price_accommodation_breakfast }} PLN</strong><br />
                        {% trans "Accommodation + dinner" %}: <strong>{{ zosia.price_accommodation_dinner }} PLN</strong><br />
                        {% trans "Accommodation + both meals" %}: <strong>{{ zosia.price_whole_day }} PLN</strong><br />
                    </blockquote>
                    <blockquote style="border-left-color: #9900ff">
                        <i>{% trans "Total cost (updated automatically)" %}:</i><br />
                        <strong><span id="total-price">{% if object %}{{object.price}}{% else %}0{% endif %}</span> PLN</strong>
                    </blockquote>
                </div>
            </div>
        </div>
    </div>
    <form method="post">
        {% csrf_token %}
        {% include '_form.html' %}
    </form>
</div>
{% endblock content %}

{% block custom_scripts %}
<script type="text/javascript">
  $(document).ready(function() {
    var elems = document.querySelectorAll('.modal');
    var instances = M.Modal.init(elems, {});
    $('select').formSelect();
    $('textarea').addClass("materialize-textarea");


    const allowAddingOrgs = () => {
      const getOrganizationInput = () => {
        const labels = Array.from(document.getElementsByTagName("label"));
        const maybe_org_label = labels.filter(label => label.textContent == "Organization")[0];
        if (!maybe_org_label)
        {
          console.error("No label organization");
          return;
        }
        const org_label = maybe_org_label;
        return org_label.parentElement;
      }

      const org_input = getOrganizationInput();
      const add_org_link = document.createElement("a");
      add_org_link.textContent = "Add organization";
      add_org_link.href = "javascript:void(0)";
      add_org_link.onclick = () => { 
        M.Modal.getInstance(document.getElementById("add_org")).open();
      }
      org_input.append(add_org_link);

      const add_org_accept = document.getElementById("add_org_accept");
      add_org_accept.onclick = () => {
        const org_select = document.getElementsByName('organization')[0];
        const new_org_option = document.createElement("option");
        new_org_option.innerText = "KSI";
        new_org_option.value = "KSI";
        org_select.append(new_org_option);
        const m_org_select = M.FormSelect.getInstance(org_select);
        const elems = document.querySelectorAll('select');
        const instances = M.FormSelect.init(elems, {});
      }
    }

    allowAddingOrgs();

    {% if payed %}
    const payed = true;
    {% else %}
    const payed = false;
    {% endif %}

    const dependencies = {
        {% for accommodation, meals in field_dependencies.items %}
        "#id_{{ accommodation }}" : [ {% for m in meals %} "#id_{{ m }}", {% endfor %} ],
        {% endfor %}
    }

    const enableMeals = accommodations => {
        accommodations.forEach(accommId => {
            const isAccommChecked = $(accommId).is(':checked')
            dependencies[accommId].forEach(mealId => {
                $(mealId).attr('disabled', payed || !isAccommChecked);
                if (!isAccommChecked) {
                  $(mealId).prop('checked', false);
                }
            })
        })
    }

    const countPayment = () => {
        let totalPayment = 0;

        for (accommId in dependencies) {
            const breakfastId = dependencies[accommId].find(mealId => /breakfast/.test(mealId));
            const dinnerId = dependencies[accommId].find(mealId => /dinner/.test(mealId));
            const isAccommChecked = $(accommId).is(':checked')
            const isBreakfastChecked = $(breakfastId).is(':checked')
            const isDinnerChecked = $(dinnerId).is(':checked')

            if (!isAccommChecked && !isBreakfastChecked && !isDinnerChecked) {
                totalPayment += 0;
            } else if (isBreakfastChecked && isDinnerChecked) {
                totalPayment += {{ zosia.price_whole_day }};
            } else if (isBreakfastChecked && !isDinnerChecked) {
                totalPayment += {{ zosia.price_accommodation_breakfast }};
            } else if (!isBreakfastChecked && isDinnerChecked) {
                totalPayment += {{ zosia.price_accommodation_dinner }};
            } else {
                totalPayment += {{ zosia.price_accommodation }};
            }
        }

        $("#total-price").text(totalPayment);
    }

    for (accommId in dependencies) {
        $(accommId).change(event => {
            enableMeals(["#" + event.currentTarget.id])
            countPayment()
        })
        dependencies[accommId].forEach(mealId => $(mealId).change(event => countPayment()))
    }

    enableMeals(Object.keys(dependencies));

    if(!payed) {
        countPayment();
    }
  });
</script>
{% endblock custom_scripts %}
